//
//  SearchViewModel.m
//  ComicVine
//
//  Created by Alejandro Rodriguez on 5/27/15.
//  Copyright (c) 2015 Alejandro Rodriguez. All rights reserved.
//

#import "SearchViewModel.h"
#import "ComicVineClient.h"
#import "SearchResultsViewModel.h"
#import "ManagedVolume.h"
#import "Response.h"

#import <ReactiveCocoa/ReactiveCocoa.h>

@interface SearchViewModel ()

@property(strong, nonatomic) ComicVineClient *client;
@property(nonatomic) NSUInteger currentPage;


//Contexto de escritura
@property(nonatomic, strong) NSManagedObjectContext *privateContext;

//Contexto de lectura
@property(nonatomic, strong) NSManagedObjectContext *mainContext;


@end


@implementation SearchViewModel

- (instancetype)init
{
    self = [super init];
    if (self) {
        _client = [ComicVineClient new];
        _currentPage = 1;
    }
    return self;
}


-(NSUInteger)numberOfResults{
    return 1;
}

-(void)setQuery:(NSString *)query{
    if (![query isEqualToString:self.query]) {
        _query = [query copy];
        [self beginNewSearch];
    }
}


-(SearchResultsViewModel *) resultAtIndex:(NSUInteger) index{
    
//    ComicVineClient *client = [ComicVineClient new];
    
    return [[SearchResultsViewModel alloc] initWithImageURL:[NSURL URLWithString:@"data:image/jpeg;base64,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"] title:@"hola" subtitle:@"como estas"];
    
}

-(void) beginNewSearch{
    
    self.currentPage = 1;
    NSManagedObjectContext *context = self.privateContext;
    
    [context performBlock:^{
        [ManagedVolume deleteAllVolumesInManagedContext:context];
    }];
    
    [[[self fetchNextPage] publish] connect];
}

-(RACSignal *) fetchNextPage{
    return [[[self.client fetchVolumeWithQuery:self.query page:self.currentPage++] doNext:^(Response * response) {
        
    }] deliverOnMainThread];
}


@end
